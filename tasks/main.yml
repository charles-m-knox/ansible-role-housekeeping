#SPDX-License-Identifier: MIT-0
---
# if you run many ansible jobs over time, this directory can get a bit polluted
- name: clean up all lingering async jobs
  file:
    path: "{{ ansible_user_dir }}/.ansible_async"
    state: absent
  tags:
    - housekeeping

- name: identify all systemd coredumps
  find:
    paths: /var/lib/systemd/coredump/
    file_type: any
  register: coredump_files
  become: true
  when:
    - ansible_service_mgr == 'systemd'
  tags:
    - housekeeping

- name: delete all systemd coredumps
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ coredump_files.files }}"
  become: true
  when:
    - ansible_service_mgr == 'systemd'
  tags:
    - housekeeping

- name: clean up excess system logs
  shell: journalctl {{ journalctl_cleanup_args }}
  become: true
  when:
    - ansible_service_mgr == 'systemd'
  tags:
    - housekeeping

- name: clean up excess user logs
  shell: journalctl --user {{ journalctl_cleanup_args }}
  become: false
  when:
    - ansible_service_mgr == 'systemd'
  tags:
    - housekeeping

- name: clean up all uninstalled cached packages
  shell: pacman -Sc --noconfirm
  become: true
  when:
    - ansible_pkg_mgr == 'pacman'
  tags:
    - housekeeping

- name: clean up ALL cached packages
  shell: |
    printf "y\ny\n" | pacman -Scc
  become: true
  when:
    - ansible_pkg_mgr == 'pacman'
    - pacman_clean_all_cached_packages == True
  tags:
    - housekeeping

- name: run user-scoped host-specific housekeeping scripts
  shell: "{{ housekeeping_user_scope_script }}"
  when:
    - housekeeping_user_scope_script | length > 0
  tags:
    - housekeeping

- name: run root-scoped host-specific housekeeping scripts
  shell: "{{ housekeeping_root_scope_script }}"
  become: true
  when:
    - housekeeping_root_scope_script | length > 0
  tags:
    - housekeeping

- name: flatpak prune
  shell:
    cmd: >
      command -v flatpak >/dev/null 2>&1 && flatpak --user uninstall --unused --noninteractive
  when:
    - install_flatpak == True
  register: flatpak_user_prune
  changed_when: |
    flatpak_user_prune.stdout != 'Nothing unused to uninstall'
  tags:
    - housekeeping
    - flatpak-prune

- name: flatpak prune (system)
  shell:
    cmd: >
      command -v flatpak >/dev/null 2>&1 && flatpak --system uninstall --unused --noninteractive
  become: true
  register: flatpak_root_prune
  changed_when: |
    flatpak_root_prune.stdout != 'Nothing unused to uninstall'
  tags:
    - housekeeping
    - flatpak-prune

- name: podman safe system prune
  shell:
    cmd: >
      command -v podman >/dev/null 2>&1 && {{ podman_safe_system_prune_command }}
  register: podman_safe_system_user_prune
  changed_when: |
    podman_safe_system_user_prune.stdout != 'Total reclaimed space: 0B'
  tags:
    - housekeeping
    - podman-prune

- name: podman safe system prune (root)
  shell:
    cmd: >
      command -v podman >/dev/null 2>&1 && {{ podman_safe_system_prune_command }}
  register: podman_safe_system_root_prune
  changed_when: |
    podman_safe_system_root_prune.stdout != 'Total reclaimed space: 0B'
  become: true
  when:
    - install_flatpak == True
  tags:
    - housekeeping
    - podman-prune
